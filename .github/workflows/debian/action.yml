name: Debian Build

inputs:
  arch:
    description: 'aarch64 or amd64'
    required: true
  name:
    description: 'what to name this workflow'
    required: true

env:
  ARCH: "${{ inputs.arch }}"

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install sccache
      uses: Vee99BR/sccache-action@v0.0.1

    - name: Install makedeb
      shell: bash
      run: |
        chmod a+x ./.ci/deb/makedeb.sh
        ./.ci/deb/makedeb.sh

    - name: Download Forgejo environment
      uses: actions/download-artifact@v4
      with:
        name: forgejo-env

    - name: Load payload environment
      shell: bash
      run: |
        ./.ci/forgejo.sh --load-payload-env

    - name: Clone
      uses: actions/download-artifact@v4
      with:
        name: eden

    - name: Set up CPM cache
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/.cache
        key: ${{ inputs.name }}-${{ inputs.arch }}-cpm-${{ env.CPM_CACHE_VERSION }}

    - name: Build
      shell: bash
      env:
        ARCH: ${{ inputs.arch }}
      run: .ci/deb/build.sh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4.6.2
      with:
        name: ${{ inputs.name }}-${{ inputs.arch }}
        path: ./eden*.deb